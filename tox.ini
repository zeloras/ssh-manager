[tox]
envlist = py38, py39, py310, py311, py312, lint, security, coverage
isolated_build = True
skip_missing_interpreters = True

[testenv]
deps =
    pytest>=7.4.0
    pytest-cov>=4.1.0
    pytest-mock>=3.11.1
    pytest-xdist>=3.3.1
    pytest-benchmark>=4.0.0
    freezegun>=1.2.2
    parameterized>=0.9.0
commands =
    pytest tests/ -v --tb=short --durations=10 -x
    pytest tests/test_integration.py -v --tb=short
    pytest tests/test_cli.py -v --tb=short

[testenv:lint]
deps =
    black>=23.7.0
    isort>=5.12.0
    flake8>=6.0.0
    mypy>=1.5.0
commands =
    black --check --diff ssh_manager.py ssh_gui.py tests/
    isort --check-only --diff ssh_manager.py ssh_gui.py tests/
    flake8 ssh_manager.py ssh_gui.py tests/
    mypy ssh_manager.py ssh_gui.py --ignore-missing-imports

[testenv:security]
deps =
    bandit>=1.7.5
    safety>=2.3.0
commands =
    bandit -r ssh_manager.py ssh_gui.py -ll
    safety check

[testenv:coverage]
deps =
    {[testenv]deps}
    coverage[toml]>=7.3.0
commands =
    pytest tests/ \
        --cov=ssh_manager --cov=ssh_gui \
        --cov-report=term-missing \
        --cov-report=html:htmlcov \
        --cov-report=xml:coverage.xml \
        --cov-fail-under=85 \
        --tb=short

[testenv:performance]
deps =
    {[testenv]deps}
commands =
    pytest tests/ -m "slow" --benchmark-only --benchmark-sort=mean

[testenv:docs]
deps =
    sphinx>=7.1.0
    sphinx-rtd-theme>=1.3.0
changedir = docs
commands =
    sphinx-build -W -b html . _build/html

[testenv:build]
deps =
    build
    twine
commands =
    python -m build
    python -m twine check dist/*

[testenv:clean]
deps =
skip_install = true
commands =
    python -c "import shutil; shutil.rmtree('build', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('dist', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('htmlcov', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('.coverage', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('.pytest_cache', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('.mypy_cache', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('ssh_profile_manager.egg-info', ignore_errors=True)"

[testenv:py38-unit]
basepython = python3.8
commands = pytest tests/test_ssh_profile.py tests/test_ssh_manager.py -v

[testenv:py39-unit]
basepython = python3.9
commands = pytest tests/test_ssh_profile.py tests/test_ssh_manager.py -v

[testenv:py310-unit]
basepython = python3.10
commands = pytest tests/test_ssh_profile.py tests/test_ssh_manager.py -v

[testenv:py311-unit]
basepython = python3.11
commands = pytest tests/test_ssh_profile.py tests/test_ssh_manager.py -v

[testenv:py312-unit]
basepython = python3.12
commands = pytest tests/test_ssh_profile.py tests/test_ssh_manager.py -v

[testenv:integration]
commands =
    pytest tests/test_integration.py -v --tb=short
    pytest tests/test_cli.py -v --tb=short

[testenv:fast]
commands =
    pytest tests/test_ssh_profile.py tests/test_ssh_manager.py -v --tb=short -x

[testenv:all]
commands =
    pytest tests/ -v --tb=short --durations=10
    black --check ssh_manager.py ssh_gui.py tests/
    isort --check-only ssh_manager.py ssh_gui.py tests/
    flake8 ssh_manager.py ssh_gui.py tests/
    bandit -r ssh_manager.py ssh_gui.py -ll

[flake8]
max-line-length = 88
extend-ignore = E203, E501, W503
exclude =
    .git,
    __pycache__,
    .pytest_cache,
    .mypy_cache,
    .tox,
    venv,
    build,
    dist,
    *.egg-info

[coverage:run]
source = ssh_manager, ssh_gui
omit =
    */tests/*
    */test_*
    setup.py
    */venv/*
    .tox/*
branch = True

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
show_missing = True
precision = 2
fail_under = 85

[coverage:html]
directory = htmlcov

[coverage:xml]
output = coverage.xml
